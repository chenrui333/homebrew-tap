name: Bump formulae on schedule or request

on:
  push:
    branches:
      - main
    paths:
      - .github/workflows/autobump.yml
  workflow_dispatch:
    inputs:
      formulae:
        description: Custom list of formulae to livecheck and bump if outdated
        required: false
  schedule:
    - cron: "15 */2 * * *"

permissions:
  contents: read

jobs:
  autobump:
    runs-on: macos-latest
    steps:
      - name: Set up Homebrew
        id: set-up-homebrew
        uses: Homebrew/actions/setup-homebrew@0fd01fffe2bb7ba090ade9655fe7e89ab5c613d4
        with:
          core: false
          cask: false

      - name: Lock Homebrew to working commit
        run: |
          cd "$(brew --repository)"
          git checkout 209b66dd4eff0a0ab48ebf6120c18a2a345150bd
          echo "Locked Homebrew to commit: $(git rev-parse HEAD)"

      - name: Configure Git user
        uses: Homebrew/actions/git-user-config@0fd01fffe2bb7ba090ade9655fe7e89ab5c613d4
        with:
          username: BrewTestBot

      # - name: Set up commit signing
      #   uses: Homebrew/actions/setup-commit-signing@b2da65092292aade9599608fc29415389641b3cb
      #   with:
      #     signing_key: ${{ secrets.BREWTESTBOT_GPG_SIGNING_SUBKEY }}

      - name: Get list of autobump formulae
        id: autobump
        run: |
          autobump_list=$(brew tap-info chenrui333/homebrew-tap --json | \
            jq -c -r '.[0]["formula_names"] | join(" ")')
          echo "autobump_list=$autobump_list" >> "$GITHUB_OUTPUT"

      - name: Bump formulae
        uses: Homebrew/actions/bump-packages@0fd01fffe2bb7ba090ade9655fe7e89ab5c613d4
        continue-on-error: true
        with:
          token: ${{ secrets.HOMEBREW_GITHUB_API_TOKEN }}
          formulae: ${{ github.event.inputs.formulae || steps.autobump.outputs.autobump_list }}
          fork: false

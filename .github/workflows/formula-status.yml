name: Formula Metadata

on:
  # Run every Monday at 09:00 UTC
  schedule:
    - cron: '0 9 * * 1'
  # Allow manual triggering
  workflow_dispatch:

jobs:
  generate-metadata:
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: '3.14'

      - name: Verify dependencies
        run: |
          which python3
          which gh
          python3 --version
          gh --version

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Generate formula metadata
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 formula-status/generate_formula_status.py --output formula-status.md

      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet formula-status.md .cache/; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Changes detected"
          fi

      - name: Commit and push changes
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git add formula-status.md .cache/
          git commit -m "chore: update formula metadata

          Generated by GitHub Actions on $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          [skip ci]"
          git push origin ${{ github.ref_name }}

      - name: Summary
        run: |
          if [ -f formula-status.md ]; then
            echo "## Formula Metadata Report" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… Metadata report generated successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            TOTAL=$(grep -c '^| [a-z]' formula-status.md 2>/dev/null || echo 0)
            echo "**Total formulas**: $TOTAL" >> $GITHUB_STEP_SUMMARY

            if [ "${{ steps.check_changes.outputs.changed }}" = "true" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "ðŸ“ Changes committed and pushed" >> $GITHUB_STEP_SUMMARY
            else
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "â„¹ï¸ No changes detected" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ Failed to generate metadata report" >> $GITHUB_STEP_SUMMARY
          fi

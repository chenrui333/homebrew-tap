name: Formula Metadata

on:
  # Run every Monday at 09:00 UTC
  schedule:
    - cron: '0 9 * * 1'
    # Backup monthly run (1st day of month at 09:00 UTC)
    - cron: '0 9 1 * *'
  # Allow manual triggering
  workflow_dispatch:

concurrency:
  group: formula-status-${{ github.ref }}
  cancel-in-progress: true

jobs:
  generate-metadata:
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6
        with:
          python-version: '3.14'

      - name: Verify dependencies
        run: |
          which python3
          which gh
          python3 --version
          gh --version

      - name: Configure Git
        run: |
          git config --local user.name "github-actions"
          git config --local user.email "actions@github.com"

      - name: Generate formula metadata
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 formula-status/generate_formula_status.py --output formula-status/formula-status.md

      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet formula-status/formula-status.md .cache/; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "No changes detected"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "Changes detected"
          fi

      - name: Commit and push changes
        if: steps.check_changes.outputs.changed == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git add formula-status/formula-status.md .cache/
          git commit -m "chore: update formula metadata

          Generated by GitHub Actions on $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          [skip ci]"
          git push "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git" "HEAD:${{ github.ref_name }}"

      - name: Summary
        run: |
          if [ -f formula-status/formula-status.md ]; then
            {
              echo "## Formula Metadata Report"
              echo ""
              echo "âœ… Metadata report generated successfully"
              echo ""

              TOTAL=$(grep -c '^| [a-z]' formula-status/formula-status.md 2>/dev/null || echo 0)
              echo "**Total formulas**: $TOTAL"

              if [ "${{ steps.check_changes.outputs.changed }}" = "true" ]; then
                echo ""
                echo "ðŸ“ Changes committed and pushed"
              else
                echo ""
                echo "â„¹ï¸ No changes detected"
              fi
            } >> "$GITHUB_STEP_SUMMARY"
          else
            echo "âŒ Failed to generate metadata report" >> "$GITHUB_STEP_SUMMARY"
          fi
